# Railway Deployment Checklist

## Quick Reference Guide

### Step 1: Verify Environment Variables in Railway Dashboard

1. Go to Railway Dashboard â†’ Select IntoWork Backend service
2. Navigate to "Variables" tab
3. Ensure these variables are set:

| Variable | Example | Notes |
|----------|---------|-------|
| `DATABASE_URL` | `postgresql://user:pass@host:5432/db` | Auto-generated by Railway PostgreSQL |
| `NEXTAUTH_SECRET` | `[32+ random characters]` | **CRITICAL**: Use strong, random value |
| `JWT_SECRET` | `[32+ random characters]` | Different from NEXTAUTH_SECRET |
| `SECRET_KEY` | `[32+ random characters]` | General security key |
| `RESEND_API_KEY` | `re_xxxxx` | From Resend dashboard |
| `FROM_EMAIL` | `INTOWORK <noreply@intowork.com>` | Sender email address |
| `ENVIRONMENT` | `production` | Set to production for Railway |
| `FRONTEND_URL` | `https://intowork-dashboard.vercel.app` | Your frontend URL |

### Step 2: Generate Strong Random Secrets

Use this command to generate each secret:

```bash
openssl rand -base64 32
```

Example output:
```
aBcDeFgHiJkLmNoPqRsTuVwXyZ1234567890==
```

Copy this value and paste into Railway Variables.

### Step 3: Verify Code Changes

The following fixes have been applied:

1. **backend/start.sh** - Now checks for `NEXTAUTH_SECRET` instead of `CLERK_SECRET_KEY`
2. **backend/app/main.py** - Removed CORS wildcard (`"*"`), added secure domain allowlist
3. **backend/Dockerfile** - Updated to Python 3.12-slim for consistency

### Step 4: Deploy

```bash
# Commit the changes
git add backend/start.sh backend/app/main.py backend/Dockerfile DEPLOYMENT_FIXES.md
git commit -m "fix: Critical deployment security and configuration fixes for Railway

- Fix NEXTAUTH_SECRET validation in start.sh (was checking for non-existent CLERK_SECRET_KEY)
- Remove CORS wildcard security vulnerability, add secure domain allowlist
- Update Python version to 3.12-slim for consistency with Dockerfile.railway

These fixes are required for production-ready Railway deployment."

# Push to GitHub
git push origin main
```

### Step 5: Monitor Deployment

1. Go to Railway Dashboard
2. Select IntoWork Backend service
3. Go to "Deployments" tab
4. Watch for deployment to complete (should show green checkmark)
5. Check logs for any errors

**Expected log output**:
```
ðŸš€ DÃ©marrage IntoWork Backend sur Railway...
âœ“ DATABASE_URL vÃ©rifiÃ©e
âœ“ NEXTAUTH_SECRET vÃ©rifiÃ©e
ðŸ“Š ExÃ©cution des migrations de base de donnÃ©es...
âœ… Migrations terminÃ©es
ðŸŽ¯ DÃ©marrage du serveur FastAPI sur le port 8000
Application startup complete [uvicorn]
```

### Step 6: Test Deployment

```bash
# Test health endpoint
curl https://[your-railway-url]/health
# Expected: {"status": "healthy", "service": "intowork-backend"}

# Test root endpoint
curl https://[your-railway-url]/api
# Expected: {"status": "ok", "service": "intowork-backend", ...}
```

### Step 7: Test Frontend Integration

1. Go to Vercel Dashboard
2. Verify frontend is using correct backend URL
3. Test authentication flow:
   - Sign up with new account
   - Check backend logs for successful registration
   - Verify user is created in database

---

## Troubleshooting

### Problem: Deployment fails with "NEXTAUTH_SECRET non dÃ©finie"

**Solution**:
1. Check Railway Variables tab
2. Verify `NEXTAUTH_SECRET` is set
3. Ensure value has no leading/trailing spaces
4. Redeploy using "Deploy" button in Railway dashboard

### Problem: CORS errors in browser console

**Browser console error**:
```
Access to XMLHttpRequest at 'https://backend-url' from origin 'https://frontend-url'
has been blocked by CORS policy
```

**Solution**:
1. Verify frontend URL is in `allow_origins` in `backend/app/main.py`
2. If using Vercel preview, pattern `https://*.vercel.app` should cover it
3. Redeploy backend if you add new origins

### Problem: Database migration fails

**Log output**:
```
ERROR [sqlalchemy.engine.Engine] ...
alembic.command: Error: Can't find any migrations with context
```

**Solution**:
1. Verify `DATABASE_URL` is correctly set
2. Check PostgreSQL container is running in Railway
3. Review migrations in `backend/alembic/versions/`
4. Try manually running migrations (advanced):
   ```bash
   railway run python -m alembic upgrade head
   ```

### Problem: Health check timeout

**Railway log**:
```
Health check failed after 40s
```

**Solution**:
1. Check application startup logs
2. Verify all dependencies are installed
3. Check if migrations are taking too long
4. Increase health check timeout in Railway settings

---

## Security Checklist

- [ ] NEXTAUTH_SECRET is 32+ characters and random
- [ ] NEXTAUTH_SECRET is NOT in version control (.env files are in .gitignore)
- [ ] CORS only allows specific domains (no wildcard)
- [ ] Database URL is secure (strong password)
- [ ] Email API key (RESEND_API_KEY) is secure
- [ ] All environment variables are set in Railway (not in code)
- [ ] Python 3.12-slim base image is used
- [ ] No secrets in Docker image (using environment variables)
- [ ] Health check endpoint is accessible
- [ ] All migrations run successfully

---

## Performance Optimization

### Database Connection Pooling
Already optimized in SQLAlchemy configuration. Railway's PostgreSQL provides connection pooling.

### Static File Serving
CV uploads are served via FastAPI StaticFiles at `/uploads`. Consider CDN for production:
```bash
# Future: Move uploads to S3/CloudStorage
# Update file service to use object storage instead of local filesystem
```

### Caching
Add Redis caching layer for frequently accessed data (job listings, candidate profiles).

---

## Monitoring

### Set up alerts in Railway for:

1. **Deployment failures** - Immediate notification
2. **Health check failures** - Check every 30s, alert after 3 failures
3. **High error rates** - Alert if error rate > 5%
4. **Database connection issues** - Alert on connection pool exhaustion

### View logs:
```bash
# Stream logs from Railway CLI
railway logs --service intowork-backend --follow

# Or use Railway Dashboard â†’ Deployments â†’ View logs
```

---

## Emergency Rollback

If deployment has critical issues:

1. Go to Railway Dashboard
2. Deployments tab
3. Find previous successful deployment
4. Click "Redeploy" on that version

---

## Additional Resources

- [Railway Documentation](https://docs.railway.app/)
- [FastAPI Deployment Guide](https://fastapi.tiangolo.com/deployment/)
- [SQLAlchemy Migration Guide](https://alembic.sqlalchemy.org/)
- [CORS Security Best Practices](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS)

---

**Last Updated**: 2025-12-26
**Status**: Ready for Production Deployment
